<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
  <meta charset="UTF-8">
  <title>Gráficos - StudyBuddy</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* Hacemos los contenedores de gráficos más altos */
    .chart-container {
      position: relative;
      height: 300px; /* Altura fija para barras y donut */
      width: 100%;
    }
    .chart-container-lg {
      position: relative;
      height: 400px; /* Altura mayor para el gráfico de línea */
      width: 100%;
    }
    .card {
        border: none;
        border-radius: 12px;
        transition: transform 0.2s;
    }
    .card:hover {
        transform: translateY(-5px);
    }
  </style>
</head>
<body class="bg-light">

<div th:replace="fragments/navbar :: navbar(active='graficos', usuario=${usuario})"></div>

<div class="container mt-5 mb-5">
  <div class="row align-items-center mb-4">
    <div class="col">
        <h2 class="fw-bold text-primary"><i class="fas fa-chart-pie me-2"></i>Estadísticas de la Plataforma</h2>
        <p class="text-muted">Visualiza las tendencias de estudio y grupos en tiempo real.</p>
    </div>
  </div>

  <div class="row g-4 mb-4">
    <div class="col-lg-5">
      <div class="card shadow h-100">
        <div class="card-header bg-white py-3">
            <h5 class="card-title mb-0 fw-bold text-secondary">Preferencias de Estudio</h5>
        </div>
        <div class="card-body d-flex align-items-center justify-content-center">
            <div class="chart-container">
                <canvas id="pieChart"></canvas>
            </div>
            <div th:if="${#lists.isEmpty(preferenciasLabels)}" class="position-absolute text-center text-muted">
                <small>No hay datos de preferencias aún</small>
            </div>
        </div>
      </div>
    </div>

    <div class="col-lg-7">
      <div class="card shadow h-100">
        <div class="card-header bg-white py-3">
            <h5 class="card-title mb-0 fw-bold text-secondary">Popularidad de Materias</h5>
        </div>
        <div class="card-body">
            <div class="chart-container">
                <canvas id="barChart"></canvas>
            </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-12">
      <div class="card shadow">
        <div class="card-header bg-white py-3">
            <h5 class="card-title mb-0 fw-bold text-secondary">Miembros por Grupo de Estudio</h5>
        </div>
        <div class="card-body">
            <div class="chart-container-lg">
                <canvas id="lineChart"></canvas>
            </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script th:inline="javascript">
/*<![CDATA[*/
    // Datos recibidos desde el controlador
    const gruposLabels = /*[[${nombresGrupos}]]*/ [];
    const gruposData = /*[[${dataMiembros}]]*/ [];

    const materiasLabels = /*[[${materiasLabels}]]*/ [];
    const materiasData = /*[[${materiasValues}]]*/ [];

    const prefLabels = /*[[${preferenciasLabels}]]*/ [];
    const prefData = /*[[${preferenciasValues}]]*/ [];
/*]]>*/

    // Configuración común para que se vean bien
    Chart.defaults.font.family = "'Segoe UI', 'Helvetica', 'Arial', sans-serif";
    Chart.defaults.color = '#666';

    // 1. Gráfico Circular (Donut)
    if (document.getElementById('pieChart')) {
        new Chart(document.getElementById('pieChart'), {
            type: 'doughnut',
            data: {
                labels: prefLabels,
                datasets: [{
                    data: prefData,
                    backgroundColor: [
                        '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b', '#858796'
                    ],
                    hoverOffset: 10,
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'right' }
                },
                cutout: '70%' // Hace el agujero del donut más grande (más moderno)
            }
        });
    }

    // 2. Gráfico de Barras
    if (document.getElementById('barChart')) {
        new Chart(document.getElementById('barChart'), {
            type: 'bar',
            data: {
                labels: materiasLabels,
                datasets: [{
                    label: 'Estudiantes',
                    data: materiasData,
                    backgroundColor: '#4e73df',
                    borderRadius: 5 // Bordes redondeados en las barras
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, grid: { borderDash: [2] } },
                    x: { grid: { display: false } }
                },
                plugins: { legend: { display: false } }
            }
        });
    }

    // 3. Gráfico de Línea
    if (document.getElementById('lineChart')) {
        new Chart(document.getElementById('lineChart'), {
            type: 'line',
            data: {
                labels: gruposLabels,
                datasets: [{
                    label: 'Cantidad de Miembros',
                    data: gruposData,
                    borderColor: '#e74a3b',
                    backgroundColor: 'rgba(231, 74, 59, 0.05)',
                    fill: true,
                    tension: 0.4, // Curva suave
                    pointRadius: 6,
                    pointHoverRadius: 8,
                    pointBackgroundColor: '#e74a3b'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, ticks: { stepSize: 1 } },
                    x: { grid: { display: false } }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                }
            }
        });
    }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>